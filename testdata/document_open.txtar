# Init phase
lsp initialize input/initialize.json
lsp initialized input/initialized.json
lsp workspace/didChangeConfiguration input/didChangeConfiguration.json

# open document w/o errors
lsp textDocument/didOpen input/didOpen_x.json
cmpenv output/notify1.json expected/notify1.json

# open document with errors
lsp textDocument/didOpen input/didOpen_y.json
cmpenv output/notify2.json expected/notify2.json

# gno transpile should have created a *.gno.gen.go files
cmp $GNOPLS_WD/script-document_open/x.gno.gen.go x.gno.gen.go.golden
cmp $GNOPLS_WD/script-document_open/y.gno.gen.go y.gno.gen.go.golden

-- x.gno --
package foo

func Hello() {}
-- y.gno --
package foo

var x X

func Bye() {
	y := 1
}
-- input/initialize.json --
{
	"rootUri": "file://$WORK"
}
-- input/initialized.json --
{}
-- input/didChangeConfiguration.json --
{
	"settings": {
		"gno":              "$GOBIN/gno",
		"gopls":            "$GOBIN/gopls",
		"root":             "$GNOPATH",
		"precompileOnSave": true,
		"buildOnSave":      true
	}
}
-- input/didOpen_x.json --
{
	"textDocument": {
		"uri":"file://$WORK/x.gno",
		"text":"${FILE_x.gno}"
	}
}
-- input/didOpen_y.json --
{
	"textDocument": {
		"uri":"file://$WORK/y.gno",
		"text":"${FILE_y.gno}"
	}
}
-- expected/notify1.json --
{
  "jsonrpc": "2.0",
  "method": "textDocument/publishDiagnostics",
  "params": {
    "uri": "file://$WORK/x.gno",
    "diagnostics": []
  }
}
-- expected/notify2.json --
{
  "jsonrpc": "2.0",
  "method": "textDocument/publishDiagnostics",
  "params": {
    "uri": "file://$WORK/y.gno",
    "diagnostics": [
      {
        "range": {
          "start": {
            "line": 2,
            "character": 6
          },
          "end": {
            "line": 2,
            "character": 4294967294
          }
        },
        "severity": 1,
        "code": "typecheck",
        "source": "gnopls",
        "message": "undefined: X"
      },
      {
        "range": {
          "start": {
            "line": 5,
            "character": 1
          },
          "end": {
            "line": 5,
            "character": 4294967294
          }
        },
        "severity": 1,
        "code": "typecheck",
        "source": "gnopls",
        "message": "declared and not used: y"
      }
    ]
  }
}
-- x.gno.gen.go.golden --
// Code generated by github.com/gnolang/gno. DO NOT EDIT.

//go:build gno

//line x.gno:1:1
package foo

func Hello() {}
-- y.gno.gen.go.golden --
// Code generated by github.com/gnolang/gno. DO NOT EDIT.

//go:build gno

//line y.gno:1:1
package foo

var x X

func Bye() {
	y := 1
}
